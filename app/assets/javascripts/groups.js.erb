//ACTIVITY FEED
function ActivityFeedsController ($scope, $http) {
  $http.get('/achievements/newest.json?groupid=' + 1 + '&latestachievement=').success(function (data) {
    $scope.achievements = data;
    $scope.orderProp = '-id';

    var max = 0, maxIndex = -1;

    function updateMax (data) {
      for(var i=0;i<data.length;i++) {
       if(parseInt(data[i].id,10) > max) {
          max = data[i].id;
          maxIndex = i;
        }
      }
    }

    updateMax($scope.achievements);


    function recursivePoll () {
      setTimeout(function () {
        $http.get('/achievements/newest.json?groupid=' + 1 +'&latestachievement=' + max).success(function (data) {
          // Prepend the scope achievements with the new data,
          // make sure the result is only 20 items long
          $scope.achievements = data.concat($scope.achievements).splice(0, 19);
          updateMax($scope.achievements);
          $scope.$$phase || $scope.$apply();
        }).success(recursivePoll);
      }, 20000);
    }

    recursivePoll();
    
  }).error(function (error) {
    console.log(error);
  });
}

//HIGHCHARTS
$(function () {
        $('#user_chart').highcharts({
            chart: {
                type: 'line',
                marginRight: 130,
                marginBottom: 25
            },
            title: {
                text: 'Group Star Chart',
                x: -20 //center
            },
            subtitle: {
                text: '(subtitle optional)',
                x: -20
            },
            xAxis: {
                categories: <%= ChartHelper.build_x_axis %>
            },
            yAxis: {
                title: {
                    text: 'Stars'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                valueSuffix: ' stars'
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -10,
                y: 100,
                borderWidth: 0
            },
            series: [
            <% User.includes.each do |user| %>
            {
                name: '<%= user.name %>',
                data: <%= ChartHelper.build_achievements_for(user) %>
            },
            <% end %>
            ]
        });
    });



